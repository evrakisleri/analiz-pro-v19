<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Müdür Paneli - Analiz Pro v19</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <style>
    body { background: #05080f; font-family: 'Inter', sans-serif; color: white; }
    input::placeholder { color: #475569; }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <header class="flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
      <h1 class="text-2xl font-black italic text-blue-500 uppercase tracking-tighter">MÜDÜR KOMUTA MERKEZİ</h1>
      <button onclick="location.href='index.html'" class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-power-off"></i> Çıkış</button>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
      <div class="bg-green-600/10 border border-green-500/20 p-6 rounded-2xl text-center">
        <h3 class="text-[10px] uppercase font-bold text-slate-400 mb-2">9A Sınıfı Analizi</h3>
        <p class="text-3xl font-black italic text-green-400">%85</p>
      </div>
      <div class="bg-yellow-600/10 border border-yellow-500/20 p-6 rounded-2xl text-center">
        <h3 class="text-[10px] uppercase font-bold text-slate-400 mb-2">9B Sınıfı Analizi</h3>
        <p class="text-3xl font-black italic text-yellow-400">%72</p>
      </div>
      <div class="bg-red-600/10 border border-red-500/20 p-6 rounded-2xl text-center">
        <h3 class="text-[10px] uppercase font-bold text-slate-400 mb-2">9C Sınıfı Analizi</h3>
        <p class="text-3xl font-black italic text-red-400">%60</p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="bg-slate-900/40 p-10 rounded-[3rem] border border-slate-800">
        <h3 class="text-xs font-black uppercase text-blue-500 mb-6 tracking-widest text-center">Tekli Personel Mühürleme</h3>
        <div class="space-y-4">
          <input type="text" id="fullName" placeholder="Ad Soyad" class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:border-blue-500 transition-all">
          <input type="email" id="email" placeholder="Kurumsal E-posta" class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:border-blue-500 transition-all">
          <input type="text" id="classBranch" placeholder="Sınıf (Örn: 10-A) veya Branş" class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:border-blue-500 transition-all">
          <select id="role" class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:border-blue-500 transition-all">
            <option value="student">Öğrenci</option>
            <option value="teacher">Öğretmen</option>
          </select>
          <button id="addBtn" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black uppercase text-xs tracking-widest transition-all">Sisteme Mühürle</button>
        </div>
      </div>

      <div class="bg-slate-900/40 p-10 rounded-[3rem] border border-dashed border-slate-800 text-center flex flex-col justify-center items-center">
        <i class="fas fa-file-csv text-5xl text-blue-500/20 mb-4"></i>
        <h3 class="text-xs font-black uppercase text-slate-500 mb-2">Toplu Veri Aktarımı</h3>
        <p class="text-[10px] text-slate-600 mb-6">Mevcut CSV listesini sürükleyin veya seçin.</p>
        
        <div class="flex flex-col gap-3 w-full max-w-[200px]">
          <button onclick="document.getElementById('fileIn').click()" class="bg-slate-800 px-8 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-white hover:text-black transition-all">Dosya Seç</button>
          <input type="file" id="fileIn" class="hidden" accept=".csv">
          <button id="tplBtn" class="bg-blue-600/20 text-blue-400 border border-blue-500/30 px-6 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-blue-600 hover:text-white transition-all">Örnek Şablon İndir</button>
        </div>
      </div>
    </div>

    <div class="mt-16 text-center border-t border-slate-800 pt-10">
      <h3 class="text-xs font-black uppercase text-slate-600 mb-6">Analiz Pro v19 - Okul Dijital Mührü</h3>
      <div id="qrcode" class="mx-auto bg-white p-3 rounded-xl inline-block"></div>
      <p class="text-[9px] text-slate-700 mt-4 uppercase tracking-[0.2em]">Bu sistem Ramazan İNCE tarafından mühürlenmiştir</p>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    // Butonları JavaScript tarafında bağlıyoruz (modül güvenliği için)
    document.getElementById('addBtn').addEventListener('click', addUser);
    document.getElementById('tplBtn').addEventListener('click', downloadTemplate);
    document.getElementById('fileIn').addEventListener('change', uploadCSV);

    async function addUser() {
      const fullName = document.getElementById('fullName').value;
      const email = document.getElementById('email').value;
      const classBranch = document.getElementById('classBranch').value;
      const role = document.getElementById('role').value;

      if(!fullName || !email) return alert("Lütfen temel bilgileri girin kanka.");

      const { error } = await supabase.from('users').insert([{
          full_name: fullName,
          email: email,
          class_branch: classBranch,
          role: role,
          password_hash: '123456', 
          is_password_changed: false
      }]);

      if(error) alert("Hata: " + error.message);
      else alert("Başarılı: " + fullName + " sisteme mühürlendi!");
    }

    async function uploadCSV(event) {
      const file = event.target.files[0];
      if(!file) return;

      Papa.parse(file, {
        header: true,
        complete: async function(results) {
          let count = 0;
          for(const row of results.data) {
            if(row.full_name && row.email) {
              await supabase.from('users').insert([{
                full_name: row.full_name,
                email: row.email,
                class_branch: row.class_branch || '',
                role: 'student',
                password_hash: '123456',
                is_password_changed: false
              }]);
              count++;
            }
          }
          alert(count + " öğrenci başarıyla Frankfurt sunucusuna yüklendi!");
        }
      });
    }

    function downloadTemplate() {
      const csvContent = "full_name,email,class_branch\nAhmet Yilmaz,ahmet@okul.com,10-A\nAyse Demir,ayse@okul.com,10-B";
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "analiz_pro_sablon.csv";
      link.click();
    }

    // QR Kod Oluşturma
    new QRCode(document.getElementById("qrcode"), {
      text: "https://analiz-pro-v19.github.io - Resmi Okul Mührü",
      width: 100,
      height: 100,
      colorDark : "#05080f",
      colorLight : "#ffffff"
    });
  </script>
</body>
</html>
