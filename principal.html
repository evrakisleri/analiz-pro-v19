<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Analiz Pro v19 - Müdür Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-white min-h-screen">

    <div id="app" class="max-w-7xl mx-auto p-8">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Müdür Paneli</h1>
                <p id="okulAdi" class="text-gray-400">Yükleniyor...</p>
            </div>
            <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded text-sm hover:bg-red-700">Çıkış Yap</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 class="font-bold mb-2">Öğrenci Yönetimi</h3>
                <p class="text-sm text-gray-400 mb-4">Öğrenci ekle, listeyi düzenle ve şifreleri yönet.</p>
                <button class="w-full bg-blue-600 py-2 rounded hover:bg-blue-700">LİSTEYİ AÇ</button>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 class="font-bold mb-2">Sınav & Analiz</h3>
                <p class="text-sm text-gray-400 mb-4">Sınav sonuçlarını yükle, analiz raporlarını al.</p>
                <button class="w-full bg-green-600 py-2 rounded hover:bg-green-700">ANALİZİ BAŞLAT</button>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <h3 class="font-bold mb-2">QR ve Şifreler</h3>
                <p class="text-sm text-gray-400 mb-4">Öğrenci şifrelerini ve QR kartlarını yazdır.</p>
                <button class="w-full bg-purple-600 py-2 rounded hover:bg-purple-700">YAZDIR</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './supabaseClient.js';

        async function checkAccess() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return window.location.href = 'login.html';

            // Okul bilgilerini ve abonelik durumunu çek
            const { data: okul, error } = await supabase
                .from('schools')
                .select('school_name, status, trial_end_date')
                .eq('manager_email', user.email)
                .single();

            if (error || !okul) return alert("Hata: Verilere ulaşılamadı.");

            // ABONELİK KİLİT MEKANİZMASI (SaaS Gating)
            const today = new Date().toISOString().split('T')[0];
            if (okul.status === 'Suspended' || (okul.status === 'Trial' && okul.trial_end_date < today)) {
                document.body.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-screen bg-red-900 text-white p-4 text-center">
                        <h1 class="text-4xl font-bold mb-4">⚠️ Aboneliğiniz Durduruldu</h1>
                        <p>Deneme süreniz doldu veya hesabınız askıya alındı. Yönetimle iletişime geçin.</p>
                    </div>`;
                return;
            }

            document.getElementById('okulAdi').innerText = okul.school_name;
        }

        window.logout = async () => {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        };

        checkAccess();
    </script>
</body>
</html>
